<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
  <meta charset="utf-8" />
  <title>Demo24 - Custom Export Command</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <link href="css/app.css" rel="stylesheet" />
  <script src="scripts/jquery.js"></script>
  <script src="scripts/powerbi.js"></script>
</head>

<body style="margin:0;padding:0;background-color:#EEE;">

  <div id="reportContainer" />

  <script>

    // data required for embedding Power BI report
    var embedReportId = "69ad0538-a1ab-4897-bb99-cd3baaa17833";
    var embedUrl = "https://app.powerbi.com/reportEmbed";
    var accessToken = "H4sIAAAAAAAEACWWxQ70WA5G3-XfZqRwUhmpF2HmCu7CzJzWvPtUq_eWfO-Rv2P__cdKnn5K8j___dPuykzdmyaEqg2we3wDFSvUMqmUSU4eXw_5RIi_ufz60LabmKGHsZamftU8n8CwQg9i5hTGIMkaq7j18WOyorv9aMMH0FUJZOWGuZPjPLj-Xk11x_E6iBqz2YA1FWsCH8OkVR52Zy5PasipBLKQDrr1MjRTj_ipYr5WHW6Sx246DVqmgSG3CI0RFQ6qBGC0DXFfo9gZNjouUTrmekHk7-pQh6HibNYmFGKewmqYCl7YrtexiCsoQIhqeru67b1Z073yl4jb8OxLp-N4zDTOLWntZFQWvh2RSZM5AxabY7bzXt2zmtwS9p1-ZnfOFhVmmkQFm6BIXE9pc7fGrFRuT9rhpA8qgBIwdUkr8YU0SXLdHkk7wdEzzIT_7IU0KFXFkF49HAwOu5T2ZGPr0NwV-SZmauEBdKq7WJfXEzP9ndaV5AC4H1n3LCs1tWXV3HeLbY3Nss4elbZawPLJNqNy42gGKJB2hKtTdJuvWlt5johZHXToZFp5RhsoN-YXBzrCqMo4bwJcxFibXdzIm5XKmQwzgFfop_myBnmFO2jEu_cttWCyAF2TUq9cx0S37g0DW5di0OrXHrhdNLbjqtAKXOsXaNtENO-O-Ya44m6arfziEtPipmZMH5DkoI3ECbmuuwMGPVVsJBBYpOQr6MZ2ktiphh_tLV8FPpNJcykfC-0lrfMEVpzsylvwGi9RnBlfuCEWjHMMiufw0zyQkgiSLGXe1qdhGjhhlBF8Jm_MuEfVc2muP3Jp6iKuk7NVtLc-I3j5WW_ViVQQ2M_111bKpXEyrso9IB-zH_tvE9--swYdxWtreNPNmo7k160UdGflk-a7Vw3rThK7R2FlHggK7fTvVuVi36PPYk-ug4_ctDEXFSjKBmFaGBC5g0KNaUvkidZTa1y78NHGkXIuUV-wR1rUwce6a3_xnAD5JHVz9TfeQixR10IyaXZUDuyOv4aAgM6zVNs813ASMuMTQM1mLlakYvfnbNsv8Tj08s0iGFu2PBSPbMbLKOR4ZtC6FnNAX_zYOQBXAqDikXi88JQRKmRw2KrmOHB4ED_M-TEHMNcR4qcvSa5kOVgBz_otkyASIIp0yIMINJ9L5_mZG7W4sYT6fVnbvhb77f2d15NSrDG02T48aaZTh1gOqbpVkb3xaJtUzeSrUwgbvhQrA1tEn6yFY74S31heDstNdGIRA7sIUjCyIyZ4g8yWsx9gxwslCsAWyVOlJYp9YfgEOs0kAsjlrhLDfEzYnm9zJTUfi0YPXea6xWotK2698PUnr6YWwbbsHjBBXiBM9jHqZA5tJc2YU8U1rh-F35QA6pUSJWrsLXXcG-gkBX_QDsAjGheoBIfKfLk2-63XtBnHZV9iVi5J4Afgk919aDcY5CbX4cOrCvPV-LE0ko0K8ahaKZ_1r2Fcs2Ci4h7Aa4oOHmhxaPwXh895lFz1OGJZvE0FtRy3U3BaYuQgW-HSRaWtNM5B6_bY1hCjsuwU3qOCiJXvtOiU1h1q2Tgf-cI1e6hTbW3NKucGGkF_BKb2IrPTJhVfPiVYgGtozN0Ar3a3ud8H2W-fO0EqMK97dF3lob9BvAOhk4bsWqD4-h4k5MOTCvAol8Iwm13HU2S_12xYZ4SD302hVzTa6pjACyYBbB-eLwGdFuFdnHIfvZI-nDATkccDUGc9CyMnyJMPiYzQSMOW6KtHqBlZoqn0Mr8nuGTYjHw7bZxFSsPbw08Xao-LfkqbTnmp1KoRUPmDPTU3tDQ-Gin7OZlF_qb5AWXZl2-IIUt4kK-B9G1QaNLIx3Qb1lRpqYOopSD2dJcFe4hU24NikIAn7lxMqozSNVuiJQFeyR5U-DD8e-GKMiceemE2dRsmN7sZtg4Taq2NwIabHgso5zPmMXAygSy_eLrhiAm_IternwAMuUapbxbtYy--pnQEjI2npA98sq5rqIYutahO3cntd8uF46gk2zO-kepRlR-rM6oLI6i4WpATOzHNqNA6vMrEpX-bBGFKoLpw6KHqrsKEYauLwVolpca2tIaPp1brZCUm8ozzybfEBU2G2m-ovD_K-loyHWDIrwI2qabPJnVZk76Wp63tAossbqdXuf988_WNY4bvOw3pBVAcJjQWF3tM74aEwXIfaxq6LSTJkjbqIkzOre06WVyCtjQZsKKqrMGqbLyqY5UdyKIjKmraUXBjBlvKsVqgwftutG9p4z5ZOYGPqQKsJhe6DdwoFOSjxa0CxrBBIXeGO1Zi3VhDlQGAws09poa1xeX3wf2tqLZPDdV8n-HL8jLL3QBhSWhXX-EwGHpctcrmh3hswCDz6Gx44JUTH9QnIWms4BPNlOhxPz-aggagSzxYUctfP9nKK_8tHwznb30b_AVZXxAIvAeZ1kqdhT__-cOuz7xPavH8zilLa_sFzL6vJQTTB0nrdMq6o3sd6L2nu9OZTxsVcmJ6Rz_fU1rU50URGUe2xbMigbmam9Uf9YfCH2EC1IZdB_Hdj7t8Waw9dKwnOdk4hBWSQPf9rlNfsHR6CjDe4skX5pNcEJyOHikgCNiaao3e84oPlcoeRRTIKwDxt8TpiBjEIvAu7Foij36-mJ4_d4xXml2WSjNLfK_cFWehaXhurV1G9d3bWsfZHwTAGLqjFr2mVmpb0-igFML_WdqdKIgw9nzcvvnwBat47HDFFXB131a1s8hLDHAw0phu0XXrAa37rvvi47klzi_TQon-kS79u4p56eqJINzzfrl3pCm6p46S2FZ__fUP5meui1X2f5QRRK2vCWWD4NI8zlVKsMK5f6vcphqT_ViLX1klgrqsGlNXaEfKdSAbXo2kINDWgJ9sG0eos9HvnFWfWS0uLCSXRWqTrrF0GH5G4M0Xt2wOp0NCk7rJa5h7mIj5h6WW6fxZMyYAL6ujYG-KNixlO2iFA6hif-xy6AFqHwiMI8Wmd9IN_gLy-XfUgKjexkPh-xlwhwXUbzJghXHXkPsqDm9KwgxLmsS-n3RRKP1bOto7pA0I6HDqBJzxhh8cX2tzEgPULGZvFNVfxu9td1H-TdzLhZSPv4nKtYMqXvFY9whULDJYnj2-mTswLK5oXIxw2fVD-Bjs43QeNFGEznwRRgI5-FUQ4AmEpyWaDpl18yjBY_0IKvxLgDgDqze7Iv3D_L__A7jGUlRCDAAA.eyJjbHVzdGVyVXJsIjoiaHR0cHM6Ly9XQUJJLVVTLUVBU1QyLUItUFJJTUFSWS1yZWRpcmVjdC5hbmFseXNpcy53aW5kb3dzLm5ldCIsImVtYmVkRmVhdHVyZXMiOnsibW9kZXJuRW1iZWQiOmZhbHNlfX0=";

    // Get models object to access enums for embed configuration
    var models = window['powerbi-client'].models;

    // custom menu icon converts to base64 string
    var menuIcon = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAAAR1SURBVDhPXZV9TNVlFMepYWmiIrdZs7nMnE3gdgmaq9WcWivbbHP2X221+iONUCJJIXmRl3JOQLgipLbm3JpsaUuxIRibgIj4EonixMiXJF9Akcvbff99+j6/C83Fdu7z/M7znM9znvOcc4iyCGIRgFAYTbAk/nAIv/Q+6b0ag2gtiPZI9Ge+ffr1alfIMgthguGAzMMIqM22gUhmza/RVukQI5YZpdDwn9gM6SydYI3bSwIhP1EBoxCDsXEZlQxLNyorj1dzLY6M64ckA4Lcl25wXDem70DES+NtlHHIAMN3R/n7+B/crmvj/pEWPLXN+I62M3a4jZHadh4cOcXgoZN4D7Tg/6mVsV/OMnC0g9Gu6wIap8aBvgjPPu2H9cV8MieJ9c+8RNYsJ1mxCeTEJpE7M4UcRzJ5cckUzkhi83QXG+OSSJ2dQkPJrshNTAjkZZQJiXkIvPoZ8PNzWhYZs15gy1MuiifPpzQmgdKpTlvKJBVTnJQ/4WTLdCcbtKexyC1nBAuGxJSHdpRN4P06xTMA/bc4vC6dXMdzlM2YL+N5uCUVgldMXsCOSQm4H3OyLSaeTY5E2ourFVsBvf6Ih4QFCijaQY8e4B8F/Cr0dNL64cdsj5stQwdlMU9SPv1pKmPmsuvxBKoFLJu8kNwZ8ZzL3ykbOWTiaANNVvkHOVN/kFp3ASerNtNdns/g1kI8eRsZLMxgoGAt3qJMKCmVh89SFb2QcslWRwrn86vggWATQH/QXFkvMnadw9vTOfT1e/yauoy2T9+iY807nEldwtnPlnBx9XKGs9PYE/s8lY8uYHdMMt9OS6IzT8CBh4CSyJV9F3XlBloqltOU46L1yxdpXrOQ379IpiMtRcDXCRSkUTLJwe5pTtzR8RTpcWzgwx7a5eTrJzzaBnf3wqVM7tQspm/fYrw1K+jKc3Hu80Q6V7/K0KbV7Jg5h5JH5lE9NZmtsSkCfvc/YFDXDd6i99KP/Hk8g/7Gdwk2L8V3bDH+2jforXyN0+ucnE9bxkjxBr28XnyKi4poF5v1OB35Ag5GgHYtY6muAr2iX6bvQik3G1dyp+5lhn5bhLd+CdeqXuFEposWxfJGQQanPlpLcVwKW6YlUzRrEWcKBPQIGJwAhoYFM9KnXDzNcHch95pXMdL0JkN1S7mxdxkNG5TAmW9zsewr+OsKh9KzSXUsIH22ixPfKIYmD9WtlNrmUcwr+zWVp6FrAjfhuZDL1bpVuv4HimslLe6VHMhewXF3luJ1U2f3sT89i/fnJlK/TUBTKQJGPIw0CilMPcpLurWhif7uPXQ25qgCjilx6zm4M50j3xdq7bY8eqC4+ajOLqKmQrXsjcTQNIVI2kz0t7DSJyADbqqAuujtOSrdZUmPjHo4Ub9fYVHfMmU6qvTQcKWjK9J4TT/VqAZrg9UgLHUg1aOlXXYDVFwD97RJ9W2ZPDXjmFJW3pkubRzymV6oiQHaYhE1MTcRMODITmmCamzG8GFRR7Y7tP5FhExTNQb6tKFmDFn8C/NZGYeYZdyqAAAAAElFTkSuQmCC";

    var config = {
      type: 'report',
      id: embedReportId,
      embedUrl: embedUrl,
      accessToken: accessToken,
      tokenType: models.TokenType.Embed,
      settings: {
        commands: [{ // hiding built-in visual commands
          spotlight: { displayOption: models.CommandDisplayOption.Hidden },
          exportData: { displayOption: models.CommandDisplayOption.Hidden },
          seeData: { displayOption: models.CommandDisplayOption.Hidden }
        }],
        extensions: [{ // adding a custom menu command
          command: {
            name: "CustomExportCommand",
            title: "Custom Export Command",
            icon: menuIcon,
            extend: {
              visualContextMenu: {
                title: "Custom Export Command",
                menuLocation: models.MenuLocation.Top
              },
              visualOptionsMenu: {
                title: "Custom Export Command",
                menuLocation: models.MenuLocation.Top
              }
            }
          }
        }]
      }
    };

    var reportContainer = document.getElementById('reportContainer');
    var report = powerbi.embed(reportContainer, config);

    report.on("commandTriggered", function (command) {
      var pageName = command.detail.page.name;
      var visualName = command.detail.visual.name;
      DownloadExportedVisualDataAsCsv(pageName, visualName);
    });

    async function DownloadExportedVisualDataAsCsv(pageName, visualName) {
      var reportPages = await report.getPages()
      for (var index = 0; index < reportPages.length; index++) {
        if (reportPages[index].name === pageName) {
          var targetPage = reportPages[index];
          // get visuals for that page
          var pageVisuals = await targetPage.getVisuals();
          // enumerate through visual to find target visual
          for (var indexVisuals = 0; indexVisuals < pageVisuals.length; indexVisuals++) {
            if (pageVisuals[indexVisuals].name === visualName) {
              // retrieve reference to target visual
              var targetVisual = pageVisuals[indexVisuals];
              // call exportData on visual
              var exportedDataResult = await targetVisual.exportData(models.ExportDataType.Summarized, 100);
              var exportedDataRaw = exportedDataResult.data;
              console.log(exportedDataRaw);
              // convert exported data in encoded URI format
              var exportedData = encodeURIComponent(exportedDataRaw);
              // trigger download of exported file as CSV file in browser
              var element = document.createElement('a');
              element.setAttribute('href', 'data:text/csv,' + exportedData);
              element.setAttribute('download', "data.csv");
              element.style.display = 'none';
              document.body.appendChild(element);
              element.click();
              document.body.removeChild(element);
            }
          }
        }
      }
    }

    $(function () {
      var widthBuffer = 12;
      var heightBuffer = 24;
      $("#reportContainer").height($(window).height() - heightBuffer);
      $("#reportContainer").width($(window).width() - widthBuffer);
      $(window).resize(function () {
        $("#reportContainer").height($(window).height() - heightBuffer);
        $("#reportContainer").width($(window).width() - widthBuffer);
      });
    });



  </script>

</body>
</html>